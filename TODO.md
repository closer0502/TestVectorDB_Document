**# ✅ TODO（MCP連携・ベクターDB機能）**

---

### 🔧 開発中機能（近日実装）

* [ ] `/ingest` ファイルアップロード → 即インジェスト
* [ ] `/delete_collection` コレクション削除
* [ ] `/collections` 一覧取得・切替
* [ ] 検索クエリ整形オプション
* [ ] クエリログ保存／キャッシュ機構
* [ ] `/context` LLMプロンプト用整形出力

---


## 🧠 機能カテゴリ別まとめ

---

### 1. 外部操作API（HAL/ユーザーからの直接操作）

| エンドポイント               | 内容                  |
| --------------------- | ------------------- |
| `/search`             | 意味検索（実装済）           |
| `/ingest`             | ファイルアップロード＆DB登録     |
| `/delete_collection`  | コレクション初期化／削除        |
| `/status`             | コレクション一覧／登録件数の取得    |
| `/collections/switch` | プロジェクト単位で使用コレクション切替 |

---

### 2. HAL/LLMメタ設計要件

* 冪等性（idempotency）に対応（例：同一ファイル再送対策）
* チャンクに `page`, `source_type`, `chunk_id`, `source_url` 等のメタ情報
* 「検索→再検索→再要約」など再帰的検索に強い構造
* クエリ履歴・中間出力も保持（LLMの思考ログとしても活用）

---

### 3. HALからの直接操作想定（MCP要件）

| 機能         | 説明                                                     |
| ---------- | ------------------------------------------------------ |
| ファイルアップロード | LLMからのデータ送信 → 型付きでDB登録                                 |
| クエリ生成の自由度  | 曖昧命令（例：「○○に関する仕様を探せ」）に耐える設計                            |
| 検索結果整形     | `title`, `chunk_id`, `score`, `summary`, `page`など整えた出力 |
| コレクション切替   | HALが「コレクション：〇〇」に応じて動的に切替可能                             |

---

### 4. LLM連携・補助機能

| 機能                   | 目的                       |
| -------------------- | ------------------------ |
| クエリログ保存              | LLMが「過去の質問・回答」に基づいて推論できる |
| `/context?query=...` | 検索結果をそのままプロンプト用に整形       |
| キャッシュ処理              | 同一クエリの応答高速化（冪等性＋再利用性）    |

---

## 🥇 最小構成（MVP）

* `/search`（済）
* `/ingest`
* `/delete_collection`
* `/switch_collection`

---

## ⏭️ 次のステップ提案

1. `/ingest` を FastAPIの `UploadFile` で対応
2. 続いて `/collections` 系管理APIを追加
3. 並行して `/context` やクエリ履歴保存を試験導入
